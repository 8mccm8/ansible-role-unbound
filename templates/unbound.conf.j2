# {{ ansible_managed }}
# See the unbound.conf(5) man page.
#
# See /usr/share/doc/unbound/examples/unbound.conf for a commented
# reference config file.

server:
    # The following line will configure unbound to perform cryptographic
    # DNSSEC validation using the root trust anchor.
{% for config in unbound_configuration %}
    {{ config.keys().0 }}: {{ config.values().0 }}
{% endfor %}
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
{% for interface in unbound_interfaces %}
    interface: {{interface}}
{% endfor %}
{% for access_control in unbound_access_control %}
    access-control: {{access_control}}
{% endfor %}

    hide-identity: yes
    hide-version: yes

{% for private_address in unbound_private_address %}
    private-address: {{private_address}}
{% endfor %}

{% for domain in unbound_domains.keys() %}
    local-zone: "{{domain}}." {{unbound_local_zone_type[domain] | default(unbound_default_local_zone)}}
{% for host in unbound_domains[domain] %}
    local-data: "{{ host.keys().0 }}.{{ domain }}. {{ host.values().0 }}{% if host.values().0 | match(".*CNAME.*[^.]") %}{{ domain }}.{% endif %}"

{% endfor %}
{% endfor %}

{% for domain in unbound_domains_with_reverses.keys() %}
    local-zone: "{{domain}}." {{unbound_local_zone_type[domain] | default(unbound_default_local_zone)}}
{% for host in unbound_domains_with_reverses[domain] %}
    local-data: "{{ host.keys().0 }}.{{ domain }}. IN A {{ host.values().0 }}"
    local-data-ptr: "{{ host.values().0 }} {{ host.keys().0 }}.{{ domain }}"
{% endfor %}
{% endfor %}


{% for group, domain in unbound_inventory_domain.iteritems() %}
    local-zone: "{{domain}}." {{unbound_local_zone_type[unbound_inventory_domain] | default(unbound_default_local_zone)}}
{% endfor %}

{% for group, domain in unbound_inventory_domain.iteritems() %}
    # Group {{group}}
{% for host in groups[group] %}
    local-data: "{{ host }}.{{ domain }}. IN A {{ hostvars[host][ 'ansible_ssh_host'] }}"
{% endfor %}
{% endfor %}


{% for group, domain in unbound_inventory_reverse_domain.iteritems() %}
    # Reverse for group {{group}}
{% for host in groups[group] %}
    local-data-ptr: "{{ hostvars[host]['ansible_ssh_host'] }} {{ host }}.{{ domain }}."
{% endfor %}
{% endfor %}

{% if unbound_forward_zone_active %}
    forward-zone:
        name: "."
{% for forward_addr in unbound_forward_zone %}
        forward-addr: {{forward_addr}}
{% endfor %}      
{% endif %}
