# {{ ansible_managed }}
# See the unbound.conf(5) man page.
#
# See /usr/share/doc/unbound/examples/unbound.conf for a commented
# reference config file.

server:
    # The following line will configure unbound to perform cryptographic
    # DNSSEC validation using the root trust anchor.
{% for config in unbound_configuration %}
    {{ config.keys().0 }}: {{ config.values().0 }}
{% endfor %}
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
{% for interface in unbound_interfaces %}
    interface: {{interface}}
{% endfor %}
{% for access_control in unbound_access_control %}
    access-control: {{access_control}}
{% endfor %}

    hide-identity: yes
    hide-version: yes

{% for private_address in unbound_private_address %}
    private-address: {{private_address}}
{% endfor %}

{% for domain in unbound_domains %}
    local-zone: "{{domain.domain_name}}." {{unbound_local_zone_type[domain.domain_name] | default(unbound_default_local_zone)}}
{% for subdomain, entry in domain.iteritems() %}
{% if subdomain != "domain_name" %}
    local-data: "{{ subdomain }}.{{ domain.domain_name }}. {{ entry }}{% if entry | match("^.*CNAME.*[^.]$") %}.{{ domain.domain_name }}.{% endif %}"
{% endif %}
{% endfor %}
{% endfor %}

{% for domain in unbound_domains_with_reverses %}
    local-zone: "{{domain.domain_name}}." {{unbound_local_zone_type[domain.domain_name] | default(unbound_default_local_zone)}}
{% for subdomain, ip in domain.iteritems() %}
{% if subdomain != "domain_name" %}
    local-data: "{{ subdomain }}.{{ domain.domain_name }}. IN A {{ ip }}"
    local-data-ptr: "{{ ip }} {{ subdomain }}.{{ domain.domain_name }}"
{% endif %}
{% endfor %}
{% endfor %}

{% for group, domain in unbound_inventory_domain.iteritems() %}
    local-zone: "{{domain}}." {{unbound_local_zone_type[unbound_inventory_domain] | default(unbound_default_local_zone)}}
{% endfor %}

{% for group, domain in unbound_inventory_domain.iteritems() %}
    # Group {{group}}
{% for host in groups[group] %}
    local-data: "{{ host }}.{{ domain }}. IN A {{ hostvars[host][ 'ansible_ssh_host'] }}"
{% endfor %}
{% endfor %}


{% for group, domain in unbound_inventory_reverse_domain.iteritems() %}
    # Reverse for group {{group}}
{% for host in groups[group] %}
    local-data-ptr: "{{ hostvars[host]['ansible_ssh_host'] }} {{ host }}.{{ domain }}."
{% endfor %}
{% endfor %}

{% if unbound_forward_zone_active %}
    forward-zone:
        name: "."
{% for forward_addr in unbound_forward_zone %}
        forward-addr: {{forward_addr}}
{% endfor %}      
{% endif %}
